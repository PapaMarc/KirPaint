<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<title>GLightbox Test</title>
	<!-- Local GLightbox CSS (kept local to avoid CDN issues) -->
	<link rel="stylesheet" href="../glightbox/glightbox.min.css">
	<!-- Custom overrides (adds counter element styling) -->
	<link rel="stylesheet" href="../glightbox/glightbox.custom.css">
	<style>
		body {
			font-family: Arial, Helvetica, sans-serif;
			padding: 20px
		}

		#gallery a {
			display: inline-block;
			margin: 6px
		}

		#gallery img {
			width: 200px;
			height: 150px;
			object-fit: cover;
			border: 1px solid #ccc
		}

		#test-caption {
			position: fixed;
			left: 20px;
			right: 20px;
			bottom: 20px;
			background: rgba(0, 0, 0, 0.7);
			color: #fff;
			padding: 8px;
			border-radius: 4px;
			font-size: 14px
		}

		/* Hide the duplicated #test-caption when it's moved into the lightbox overlay */
		.glightbox-container #test-caption,
		.glightbox-overlay #test-caption {
			display: none !important;
		}
	</style>
</head>

<body>
	<h1>GLightbox Minimal Test</h1>
	<p>Click thumbnails to open the GLightbox viewer. Rapidly navigate with arrows to test caption updates.</p>
	<div id="gallery"></div>

	<div id="test-caption" aria-hidden="false"></div>

	<!-- PhotoSwipe vendor files will be loaded on demand by the controls below -->

	<!-- Controls: show which PhotoSwipe variant is being used and allow switching -->
	<script>
		(function () {
			// create container under the gallery (will insert after #gallery)
			var gallery = document.getElementById('gallery');
			var cont = document.createElement('div');
			cont.id = 'test-controls';
			cont.style.marginTop = '12px';

			var status = document.createElement('div');
			status.id = 'test-status';
			status.style.background = 'rgba(0,0,0,0.75)';
			status.style.color = '#fff';
			status.style.padding = '6px 8px';
			status.style.borderRadius = '6px';
			status.style.fontSize = '13px';
			status.style.display = 'block';
			status.style.marginBottom = '6px';

			// full path display
			var pathsBox = document.createElement('div');
			pathsBox.id = 'pswp-paths';
			pathsBox.style.fontSize = '12px';
			pathsBox.style.color = '#333';
			pathsBox.style.marginBottom = '6px';

			var label = document.createElement('label');
			label.textContent = 'PhotoSwipe variant: ';
			label.style.display = 'block';
			label.style.marginBottom = '4px';

			var select = document.createElement('select');
			select.id = 'pswp-variant-select';
			select.style.display = 'block';
			select.style.marginBottom = '8px';

			var opG = document.createElement('option'); opG.value = 'glightbox'; opG.textContent = 'glightbox (../glightbox/)';
			var opPhotoswipe = document.createElement('option'); opPhotoswipe.value = 'photoswipe'; opPhotoswipe.textContent = 'photoswipe (../photoswipe/)';
			var opVendor = document.createElement('option'); opVendor.value = 'vendor'; opVendor.textContent = 'vendor (vendor/)';
			var opNone = document.createElement('option'); opNone.value = 'none'; opNone.textContent = 'none (use fallback)';
			select.appendChild(opG);
			select.appendChild(opPhotoswipe); select.appendChild(opVendor); select.appendChild(opNone);

			var btn = document.createElement('button'); btn.id = 'pswp-run'; btn.textContent = 'Load/Reload test-init.js'; btn.style.marginRight = '8px';
			var info = document.createElement('span'); info.id = 'pswp-info'; info.style.marginLeft = '6px'; info.style.color = '#666';

			cont.appendChild(status);
			cont.appendChild(pathsBox);
			cont.appendChild(label);
			cont.appendChild(select);
			cont.appendChild(btn);
			cont.appendChild(info);

			// insert after gallery
			if (gallery && gallery.parentNode) gallery.parentNode.insertBefore(cont, gallery.nextSibling);
			else document.body.appendChild(cont);

			function updateStatus(msg, paths) {
				status.textContent = 'Using: ' + msg; window.__r2_photoswipe_using = msg; pathsBox.innerHTML = '';
				if (Array.isArray(paths)) {
					paths.forEach(function (p) { var d = document.createElement('div'); d.textContent = p; d.style.fontFamily = 'monospace'; d.style.fontSize = '12px'; pathsBox.appendChild(d); });
				}
			}

			var variants = {
				'glightbox': ['../glightbox/glightbox.min.js'],
				'photoswipe': ['../photoswipe/photoswipe.umd.min.js', '../photoswipe/photoswipe-lightbox.umd.min.js'],
				'vendor': ['vendor/photoswipe.umd.min.js', 'vendor/photoswipe-lightbox.umd.min.js'],
				'none': []
			};

			// choose default: prefer local glightbox if present
			select.value = 'glightbox';

			function loadScripts(urls, cb) {
				if (!urls || !urls.length) return cb && cb();
				var i = 0;
				function next() { if (i >= urls.length) return cb && cb(); var s = document.createElement('script'); s.src = urls[i] + '?ts=' + Date.now(); s.onload = function () { i++; next(); }; s.onerror = function () { console.warn('failed to load', urls[i]); i++; next(); }; document.head.appendChild(s); }
				next();
			}

			function applyAndLoad(name) {
				var paths = variants[name] || [];
				updateStatus('loading...', paths);
				// remove any previous pswp globals
				try { delete window.PhotoSwipe; delete window.PhotoSwipeLightbox; delete window.V3_PhotoSwipe; delete window.V3_PhotoSwipeLightbox; } catch (e) { }
				loadScripts(paths, function () {
					if (name === 'glightbox') {
						updateStatus('glightbox loaded', paths);
						try { initGLightbox(); } catch (e) { console.error('initGLightbox failed', e); }
					} else if (name === 'photoswipe' || name === 'vendor') {
						updateStatus(name + ' loaded', paths);
						// fall back to existing test-init which expects PhotoSwipe
						loadTestInit();
					} else {
						updateStatus('none (fallback)', []);
						loadTestInit();
					}
				});
			}

			function loadTestInit() {
				var old = document.getElementById('test-init-script'); if (old) old.remove(); try { window.__test_lightbox = undefined; } catch (e) { }
				var s = document.createElement('script'); s.id = 'test-init-script'; s.src = 'test-init.js?ts=' + Date.now(); s.onload = function () { info.textContent = ' initialized'; }; s.onerror = function () { info.textContent = ' load failed'; };
				document.body.appendChild(s);
			}

			// Simple GLightbox initializer embedded here so this page can run independently
			function initGLightbox() {
				var galleryEl = document.getElementById('gallery');
				var captionEl = document.getElementById('test-caption');
				if (!galleryEl) return;
				// clear existing
				try { galleryEl.innerHTML = ''; } catch (e) { }
				fetch('../data/industrial.json').then(function (r) { return r.json(); }).then(function (list) {
					var items = (Array.isArray(list) ? list : []).slice(0, 6);
					items.forEach(function (it, i) {
						var a = document.createElement('a');
						a.href = it.full;
						a.className = 'glightbox';
						a.setAttribute('data-title', it.caption || '');
						var img = document.createElement('img'); img.src = it.thumb; img.alt = it.alt || ''; img.style.width = '200px'; img.style.height = '150px'; img.style.objectFit = 'cover'; img.style.border = '1px solid #ccc';
						a.appendChild(img);
						galleryEl.appendChild(a);
					});
					// init GLightbox (assumes global GLightbox available)
					try {
						window.__g = GLightbox({ selector: '.glightbox', touchNavigation: true, loop: true });
						// remove gallery-level caption mirroring; caption will be moved into the lightbox overlay
						Array.from(galleryEl.querySelectorAll('a.glightbox')).forEach(function (anchor, idx) {
							try { anchor.removeEventListener && anchor.removeEventListener('click', null); } catch (e) { }
						});

						// Install counter element and updater
						(function installCounter(glightInstance) {
							var counterEl = null;
							function createCounter() {
								if (counterEl) return counterEl;
								counterEl = document.createElement('div');
								counterEl.className = 'glightbox-counter';
								counterEl.setAttribute('aria-hidden', 'false');
								return counterEl;
							}

							function appendCounterToOverlay() {
								try {
									var overlay = document.querySelector('.glightbox-container') || document.querySelector('.glightbox-overlay');
									var parent = overlay || document.body;
									if (counterEl && counterEl.parentNode !== parent) { parent.appendChild(counterEl); }
								} catch (e) { }
							}

							function updateCounter() {
								try {
									appendCounterToOverlay();
									var container = document.querySelector('.glightbox-container');
									var slides = container ? container.querySelectorAll('.gslide') : null;
									var total = (slides && slides.length) || (document.querySelectorAll('a.glightbox').length) || 0;
									var idx = -1;
									if (slides && slides.length) {
										for (var i = 0; i < slides.length; i++) {
											var s = slides[i];
											if (s.classList && s.classList.contains('gslide-current')) { idx = i; break; }
										}
									}
									if (idx < 0) {
										try { idx = (glightInstance.index != null) ? glightInstance.index : -1; } catch (e) { }
									}
									var el = createCounter();
									appendCounterToOverlay();
									if (total > 0 && idx >= 0) el.textContent = (idx + 1) + ' / ' + total;
									else if (total > 0) el.textContent = '1 / ' + total;
									else el.textContent = '';
								} catch (e) { }
							}

							function showCounter() { createCounter(); appendCounterToOverlay(); updateCounter(); }
							function hideCounter() { if (counterEl && counterEl.parentNode) counterEl.parentNode.removeChild(counterEl); counterEl = null; }

							// attempt to bind to GLightbox events in a robust way
							try {
								if (glightInstance && typeof glightInstance.on === 'function') {
									glightInstance.on('open', function () { showCounter(); setTimeout(updateCounter, 50); });
									glightInstance.on('slide_changed', function () { setTimeout(updateCounter, 20); setTimeout(updateCounter, 140); });
									glightInstance.on('close', function () { hideCounter(); });
								} else {
									// fallback: poll while .glightbox-container exists
									var pollId = null;
									function poll() { if (document.querySelector('.glightbox-container')) { showCounter(); updateCounter(); } else { hideCounter(); } }
									document.addEventListener('click', function () { setTimeout(poll, 100); });
								}
							} catch (e) { console.warn('counter install error', e); }
						})(window.__g);

						// Install caption manager which moves #test-caption into the overlay
						(function installCaption(glightInstance) {
							if (!captionEl) captionEl = document.getElementById('test-caption');
							var originalParent = captionEl && captionEl.parentNode;

							function appendCaptionToOverlay() {
								try {
									var overlay = document.querySelector('.glightbox-container') || document.querySelector('.glightbox-overlay');
									var parent = overlay || document.body;
									if (captionEl && captionEl.parentNode !== parent) { parent.appendChild(captionEl); }
								} catch (e) { }
							}

							function updateCaptionForIndex() {
								try {
									var container = document.querySelector('.glightbox-container');
									var slides = container ? container.querySelectorAll('.gslide') : null;
									var idx = -1;
									if (slides && slides.length) {
										for (var i = 0; i < slides.length; i++) {
											if (slides[i].classList && slides[i].classList.contains('gslide-current')) { idx = i; break; }
										}
									}
									if (idx < 0) {
										try { idx = (glightInstance.index != null) ? glightInstance.index : -1; } catch (e) { }
									}
									var anchors = Array.from(document.querySelectorAll('a.glightbox'));
									var title = (anchors[idx] && anchors[idx].getAttribute('data-title')) || '';
									if (captionEl) { captionEl.textContent = title; captionEl.style.display = title ? 'block' : 'none'; }
								} catch (e) { }
							}

							function showCaption() { appendCaptionToOverlay(); updateCaptionForIndex(); }
							function hideCaption() { try { if (captionEl && originalParent && captionEl.parentNode !== originalParent) originalParent.appendChild(captionEl); if (captionEl) captionEl.textContent = ''; } catch (e) { } }

							try {
								if (glightInstance && typeof glightInstance.on === 'function') {
									glightInstance.on('open', function () { showCaption(); setTimeout(updateCaptionForIndex, 40); });
									glightInstance.on('slide_changed', function () { setTimeout(updateCaptionForIndex, 20); setTimeout(updateCaptionForIndex, 140); });
									glightInstance.on('close', function () { hideCaption(); });
								}
							} catch (e) { console.warn('caption install error', e); }
						})(window.__g);

						info.textContent = ' glightbox initialized';
					} catch (e) { console.error('GLightbox init error', e); }
				}).catch(function (err) { console.error('failed to load json for glightbox test', err); });
			}

			btn.addEventListener('click', function () { applyAndLoad(select.value); });

			// initial load
			applyAndLoad(select.value);
		})();
	</script>
	</script>

	<!-- GLightbox init shim: moves caption/counter focus/inert and swipe-fallback -->
	<script src="../glightbox/glightbox-init.js"></script>
</body>

</html>